<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✂️ Mavis' Chop Shop ✂️</title>
    <script type="py" terminal worker src="./py/config.py"></script>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <style>
        /* --- ESTÉTICA Y2K / 2000s --- */
        :root {
            --bg-color: #dcdcdc;
            --window-bg: #ffffff;
            --highlight: #ff0099;
            --border-light: #ffffff;
            --border-dark: #808080;
            --text-main: #000000;
        }

        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden; /* Mantém a vibe de "app" */
            image-rendering: pixelated; /* Crucial para pixel art */
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" style="font-size:16px"><text y="15">✂️</text></svg>'), auto;
        }

        /* Container Principal (A Sala) */
        #room-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-image: url('fundoinho.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Efeito de Scanlines (TV antiga) */
        #room-container::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 1;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* --- UI ELEMENTOS --- */
        .marquee-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: purple;
            color: white;
            padding: 5px;
            z-index: 10;
            font-size: 14px;
        }

        /* --- A GATINHA MAVIS --- */
        #mavis-wrapper {
            position: absolute;
            width: 180px; /* Tamanho ajustável da gatinha */
            height: auto;
            z-index: 5;
            transition: top 1s, left 1s; /* Movimento suave se mudar */
            cursor: pointer;
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.5));
        }

        /* A imagem da gatinha */
        #mavis-img {
            width: 100%;
            height: auto;
            display: block;
            /* Tenta remover o fundo branco do JPG via blend mode se não for PNG transparente */
            mix-blend-mode: multiply; 
        }

        /* A imagem sendo cortada (Overlay) */
        #cut-overlay {
            position: absolute;
            width: 60px; /* Pequena, cabendo na tesoura */
            height: 60px;
            top: 45%; /* Ajuste manu al para alinhar com a tesoura */
            left: 23%; /* Ajuste manual para alinhar com a tesoura */
            object-fit: contain;
            display: none; /* Escondido até carregar */
            z-index: 6;
            border: 1px dashed red;
            background: rgba(255, 255, 255, 0.8);
        }

        /* Estado de "Sucesso" (Segurando a imagem pronta) */
        #result-overlay {
            position: absolute;
            width: 80px;
            height: 80px;
            top: 35%;
            left: 20%; /* Ajuste para a pata dela na imagem sorrindo */
            display: none;
            z-index: 7;
            transform: rotate(-10deg);
            border: 2px solid #fff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }

        /* Balão de Fala (Estilo RPG/Comic) */
        .speech-bubble {
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 2px solid #000;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            white-space: nowrap;
            display: none; /* Aparece via JS */
            z-index: 20;
            box-shadow: 4px 4px 0px #000;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: #000 transparent;
            display: block;
            width: 0;
        }

        /* Input Escondido */
        #file-input {
            display: none;
        }

        /* Animação de Shake durante o corte */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shaking {
            animation: shake 0.5s;
            animation-iteration-count: infinite;
        }

        /* Rodapé de Créditos */
        .credits {
            position: absolute;
            bottom: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px; 
            border: 3px double #000;
            font-size: 10px; 
            line-height: 1.6;
            color: #000;
            z-index: 100;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.1);
            max-width: 280px;
            text-align: left;
        }
        .credits .mavis-tag {
            display: block;
            margin-top: 5px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgb(170, 0, 255);
            font-size: 12px;
        }
    </style>
</head>
<body>

    <!-- Música de fundo (Opcional, silenciado por padrão por regras de browser) -->
    <!-- <audio id="bgm" loop src="path_to_paramore_midi.mp3"></audio> -->

    <div class="marquee-container">
        <marquee scrollamount="10">*** BEM-VINDE AO ATELIÊ DA MAVIS *** CORTE SUAS IMAGENS *** UMA HOMENAGEM A NOSSA PEQUENA ANJINHA *** PYTHON POWERED ***</marquee>
    </div>

    <div id="room-container">
        
        <!-- Container da Mavis -->
        <div id="mavis-wrapper" onclick="handleMavisClick()">
            <!-- Balão de mensagem -->
            <div id="message-box" class="speech-bubble">Clique em mim para cortar!</div>
            
            <!-- Imagem Principal da Gata -->
            <img id="mavis-img" src="mavis segurando tesoura.png" alt="Mavis a gata">
            
            <!-- A imagem pequena que aparece na tesoura durante o corte -->
            <img id="cut-overlay" alt="Cortando...">
            
            <!-- A imagem final segurada -->
            <img id="result-overlay" alt="Resultado">
        </div>

        <div class="credits">
            Design: <strong>Y2K Aesthetic</strong><br>
            Dev: <strong>Python + HTML</strong><br>
            By: <strong>Lilian Chaves</strong>
            <span class="mavis-tag">Never Forget Mavis</span>
        </div>
    </div>

    <!-- Input Invisível -->
    <input type="file" id="file-input" accept="image/png, image/jpeg, image/gif, image/bmp">

    <script>
        // --- CONFIGURAÇÃO DAS IMAGENS ---
        const assets = {
            idle: 'mavis segurando tesoura.png',
            cut1: 'cortando imagem 1.png',
            cut2: 'segurando tesoura 2 (2).png',
            success: 'segura sorrindo.png'
        };
        const mavisSpots = [
            { name: "na janela", top: "6%", left: "69%", flipped: true},
            { name: "no sofá", top: "55%", left: "8%", flipped: true },
            { name: "na mansão", top: "15%", left: "48%"},
            { name: "do lado da caixa", top: "60%", left: "78%" }
        ];

        // --- ESTADOS DO SISTEMA ---
        let state = 'IDLE'; // IDLE, CUTTING, DONE
        let uploadedImageSrc = null;
        let processedImageUrl = null;

        // Elementos DOM
        const mavisWrapper = document.getElementById('mavis-wrapper');
        const mavisImg = document.getElementById('mavis-img');
        const fileInput = document.getElementById('file-input');
        const cutOverlay = document.getElementById('cut-overlay');
        const resultOverlay = document.getElementById('result-overlay');
        const messageBox = document.getElementById('message-box');

        // URL DO BACKEND NO RENDER
        const BACKEND_URL = 'https://mavis-chop-shop-backend.onrender.com/remove-bg';

        // --- 1. POSICIONAMENTO BASEADO NO HORÁRIO ---
        function setRandomPosition() {
            const randomIndex = Math.floor(Math.random() * mavisSpots.length);
            const spot = mavisSpots[randomIndex];

            mavisWrapper.style.top = spot.top;
            mavisWrapper.style.left = spot.left;

            if (spot.flipped) {
                // Inverte horizontalmente
                mavisWrapper.style.transform = "scaleX(-1)";
                // Como o wrapper inverte tudo, o balão de fala ficaria ao contrário. 
                // Invertemos o balão de volta para o texto ficar legível.
                messageBox.style.transform = "translateX(-50%) scaleX(-1)";
            } else {
                // Volta ao normal
                mavisWrapper.style.transform = "scaleX(1)";
                messageBox.style.transform = "translateX(-50%) scaleX(1)";
            }
            
            showMessage("Agora estou " + spot.name + "!");
            showMessage("Clique em mim para cortar!");
        }

        function showMessage(text) {
            messageBox.innerText = text;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        // --- 2. INTERAÇÃO DE CLIQUE ---
        function handleMavisClick() {
            if (state === 'IDLE') {
                fileInput.click(); // Abre seletor de arquivo
            } else if (state === 'DONE') {
                downloadImage();
            }
        }

        // --- 3. PROCESSAMENTO DO ARQUIVO ---
        fileInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                // Verifica tamanho do arquivo (máximo 5MB)
                if (e.target.files[0].size > 5 * 1024 * 1024) {
                    showMessage("Imagem muito grande! Máximo: 5MB");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    uploadedImageSrc = event.target.result;
                    startCuttingAnimation();
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // --- 4. ANIMAÇÃO DE CORTE (O "CORE" DO PEDIDO) ---
        function startCuttingAnimation() {
            state = 'CUTTING';
            showMessage("Cortando fundo... Isso pode levar alguns segundos!");

            // Prepara a imagem overlay
            cutOverlay.src = uploadedImageSrc;
            cutOverlay.style.display = 'block';
            cutOverlay.classList.add('shaking');

            // Animação de corte
            let frameToggle = false;
            const animationInterval = setInterval(() => {
                if (state !== 'CUTTING') {
                    clearInterval(animationInterval);
                    return;
                }
                if (frameToggle) {
                    mavisImg.src = assets.cut1;
                    cutOverlay.style.transform = "rotate(5deg)";
                } else {
                    mavisImg.src = assets.cut2;
                    cutOverlay.style.transform = "rotate(-5deg)";
                }
                frameToggle = !frameToggle;
            }, 150);

            // Envia para o backend Flask no Render
            sendToBackend()
                .then(blob => {
                    clearInterval(animationInterval);
                    
                    // Cria URL para a imagem processada
                    processedImageUrl = URL.createObjectURL(blob);
                    finishCutting();
                })
                .catch(error => {
                    clearInterval(animationInterval);
                    console.error('Erro:', error);
                    showMessage("Erro no processamento! Tente outra imagem.");
                    resetState();
                });
        }

        // --- 5. ENVIA IMAGEM PARA O BACKEND ---
        async function sendToBackend() {
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            const response = await fetch(BACKEND_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Erro no servidor');
            }

            return await response.blob();
        }

        // --- 6. RESULTADO FINAL ---
        function finishCutting() {
            state = 'DONE';
            
            // Remove animações de corte
            cutOverlay.style.display = 'none';
            cutOverlay.classList.remove('shaking');

            // Muda Mavis para imagem sorrindo
            mavisImg.src = assets.success;

            // Mostra o resultado real da remoção de fundo
            resultOverlay.src = processedImageUrl; 
            resultOverlay.style.display = 'block';

            showMessage("Pronto! Clique para baixar.");
        }

        // --- 7. DOWNLOAD DA IMAGEM PROCESSADA ---
        function downloadImage() {
            if (!processedImageUrl) {
                showMessage("Nenhuma imagem para baixar!");
                return;
            }

            const link = document.createElement('a');
            link.href = processedImageUrl;
            link.download = 'imagem_sem_fundo_by_mavis.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage("Imagem baixada! Próximo!");
            
            // Reseta após 2 segundos
            setTimeout(resetState, 2000);
        }

        function resetState() {
            state = 'IDLE';
            mavisImg.src = assets.idle;
            resultOverlay.style.display = 'none';
            resultOverlay.src = '';
            fileInput.value = '';
            
            // Libera memória da URL criada
            if (processedImageUrl) {
                URL.revokeObjectURL(processedImageUrl);
                processedImageUrl = null;
            }
            
            uploadedImageSrc = null;
        }

        // Inicializa
        window.onload = setRandomPosition;

    </script>
</body>
</html>

